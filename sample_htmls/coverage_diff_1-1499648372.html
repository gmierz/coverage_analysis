<!DOCTYPE html><html><head><meta charset="UTF-8"> <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script><script type="text/javascript">$(document).ready(function(){$("#table_id td.colour_me:contains('new')").css('background-color','#99ff99');$("#table_id td.colour_me:contains('ucov')").css('background-color','#ff704d');$("#table_id td.colour_me:contains('rem')").css('background-color','#af4134');$("#table_id td.colour_me:contains('ocov')").css('background-color','#3aaf34');$("#table_id td.colour_me:contains('ncov')").css('background-color','#3aaf34');    $('#table_id td.colour_me').each(function(){        if ($(this).text() == 'rem') {            $(this).css('background-color','#ff0000');        }        if ($(this).text() == 'ocov') {            $(this).css('background-color','#33cc33');        }        if ($(this).text() == 'ncov') {            $(this).css('background-color','#33cc33');        }    });});</script></head><body><table id="table_id">  <tr><td>Line No.</td>  <td class="colour_me">Old revision</td>  <td style="max-width:500px">Source Code</td>  <td class="colour_me">New Revision</td>  </tr>  <tr><td>1</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> # This Source Code Form is subject to the terms of the Mozilla Public</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>2</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> # License, v. 2.0. If a copy of the MPL was not distributed with this</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>3</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>4</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>5</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> from __future__ import absolute_import, print_function</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>6</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>7</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> import argparse</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>8</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> import sys</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>9</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> import json</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>10</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> import buildconfig</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>11</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>12</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> from mozpack.copier import Jarrer, FileRegistry</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>13</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> from mozpack.files import FileFinder, GeneratedFile</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>14</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> from mozpack.manifests import (</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>15</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     InstallManifest,</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>16</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     UnreadableInstallManifest,</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>17</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> )</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>18</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> import mozpack.path as mozpath</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>19</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>20</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> def describe_install_manifest(manifest, dest_dir):</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>21</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     try:</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>22</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">         manifest = InstallManifest(manifest)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>23</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     except UnreadableInstallManifest:</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>24</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">         raise IOError(errno.EINVAL, 'Error parsing manifest file', manifest)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>25</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>26</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     reg = FileRegistry()</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>27</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>28</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     mapping = {}</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>29</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     manifest.populate_registry(reg)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>30</td>  <td class="colour_me">new</td>  <td style="max-width:500px">+    obj_dir = mozpath.split(buildconfig.topobjdir)[-1]</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>31</td>  <td class="colour_me">new</td>  <td style="max-width:500px">+    dest_dir = mozpath.join(obj_dir, dest_dir)</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>32</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px">     for dest_file, src in reg:</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>33</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px">         if hasattr(src, 'path'):</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>34</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px">             dest_path = mozpath.join(dest_dir, dest_file)</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>35</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">             relsrc_path = mozpath.relpath(src.path, buildconfig.topsrcdir)</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>36</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px">             mapping[dest_path] = relsrc_path</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>37</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>38</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px">     return mapping</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>39</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>40</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>41</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> def package_coverage_data(root, output_file):</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>42</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     # XXX JarWriter doesn't support unicode strings, see bug 1056859</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>43</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     if isinstance(root, unicode):</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>44</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">         root = root.encode('utf-8')</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>45</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>46</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     finder = FileFinder(root)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>47</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     jarrer = Jarrer(optimize=False)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>48</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     for p, f in finder.find("**/*.gcno"):</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>49</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">         jarrer.add(p, f)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>50</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>51</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     dist_include_manifest = mozpath.join(buildconfig.topobjdir,</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>52</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px">                                          '_build_manifests',</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>53</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                                          'install',</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>54</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                                          'dist_include')</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>55</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     linked_files = describe_install_manifest(dist_include_manifest,</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>56</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                                              'dist/include')</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>57</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     mapping_file = GeneratedFile(json.dumps(linked_files, sort_keys=True))</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>58</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     jarrer.add('linked-files-map.json', mapping_file)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>59</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     jarrer.copy(output_file)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>60</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>61</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>62</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> def cli(args=sys.argv[1:]):</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>63</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     parser = argparse.ArgumentParser()</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>64</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     parser.add_argument('-o', '--output-file',</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>65</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                         dest='output_file',</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>66</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                         help='Path to save packaged data to.')</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>67</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     parser.add_argument('--root',</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>68</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                         dest='root',</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>69</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                         default=None,</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>70</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">                         help='Root directory to search from.')</td>  <td class="colour_me">ncov</td>  </tr>  <tr><td>71</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     args = parser.parse_args(args)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>72</td>  <td class="colour_me">ocov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>73</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     if not args.root:</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>74</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">         from buildconfig import topobjdir</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>75</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">         args.root = topobjdir</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>76</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>77</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     return package_coverage_data(args.root, args.output_file)</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>78</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> </td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>79</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px"> if __name__ == '__main__':</td>  <td class="colour_me">ucov</td>  </tr>  <tr><td>80</td>  <td class="colour_me">ucov</td>  <td style="max-width:500px">     sys.exit(cli())</td>  <td class="colour_me">ucov</td>  </tr></table></body></html>